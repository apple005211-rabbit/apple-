import React, { useState, useEffect } from 'react';
import { Trophy, Users, Activity, ArrowRight, RotateCcw, Award, CheckCircle, Star, Lightbulb, Volume2, BookOpen, Info, Sparkles, MessageSquareQuote, Loader2, Edit3, Gift, RefreshCw, Zap, Hand, UserPlus } from 'lucide-react';

// --- èªéŸ³æ’­æ”¾åŠŸèƒ½ ---
const speak = (text) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-TW';
    utterance.rate = 0.9; 
    utterance.pitch = 1;
    window.speechSynthesis.speak(utterance);
  } else {
    alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­æ”¾åŠŸèƒ½å–”ï¼");
  }
};

// --- è³‡æ–™è¨­å®š ---

// è¼”åŠ©å…ƒä»¶ï¼šå¯æ„›é‹å‹•ç©å¶åœ–ç¤º
const SportDoll = ({ animal, sport, size = "text-3xl" }) => (
  <div className={`flex flex-col items-center justify-center ${size} filter drop-shadow-md select-none`}>
    <span className="leading-none">{animal}</span>
    {sport && <span className="text-sm absolute -bottom-1 -right-2 bg-white rounded-full p-0.5 shadow-sm border border-gray-100">{sport}</span>}
  </div>
);

// éŠæˆ²åƒæ•¸
const WINNING_SCORE = 100;
const PERIMETER_COUNT = 24; // 7x7 å¤–æ¡†æ‰£æ‰ä¸­é–“ = 24æ ¼

// æ©Ÿæœƒå¡æ±  (å°æ‡‰åŠŸèƒ½)
const CHANCE_DECK = [
  { id: 'help', label: 'æ‰¾äººå¹«å¿™', icon: <UserPlus className="text-blue-500" />, desc: 'æŒ‡å®šä¸€ä½éšŠå‹æˆ–è€å¸«å”åŠ©å®Œæˆä¸‹ä¸€å€‹å‹•ä½œï¼', effect: 'none' },
  { id: 'repick', label: 'é‡æ–°é¸é¡Œ', icon: <RefreshCw className="text-green-500" />, desc: 'é€™å›åˆä¸ç®—ï¼Œè«‹é‡æ–°é¸æ“‡ä¸€å€‹å–œæ­¡çš„æ ¼å­ï¼', effect: 'repick' },
  { id: 'double', label: 'åˆ†æ•¸ x2', icon: <Zap className="text-yellow-500" />, desc: 'é‹æ°£çˆ†æ£šï¼ä¸‹ä¸€æ¬¡ç­”å°é¡Œç›®ï¼Œåˆ†æ•¸ç›´æ¥å…©å€ï¼', effect: 'buff_double' },
  { id: 'steal', label: 'æ‹¿å–å¾—åˆ†', icon: <Hand className="text-red-500" />, desc: 'å˜¿å˜¿ï¼å¾ç›®å‰æœ€é«˜åˆ†çš„éšŠä¼é‚£è£¡æ‹¿èµ° 10 åˆ†ï¼', effect: 'steal_10' },
  { id: 'extra', label: 'å¤šä¸€æ¬¡æ©Ÿæœƒ', icon: <Star className="text-purple-500" />, desc: 'å¤ªæ£’äº†ï¼é€™å›åˆçµæŸå¾Œï¼Œä½ å¯ä»¥å†ç©ä¸€æ¬¡ï¼', effect: 'extra_turn' },
  { id: 'bonus', label: 'å¤©ä¸Šæ‰é¤¡é¤…', icon: <Gift className="text-pink-500" />, desc: 'ä»€éº¼éƒ½ä¸ç”¨åšï¼Œç›´æ¥ç²å¾— 15 åˆ†ï¼', effect: 'add_15' },
  { id: 'help', label: 'åœ˜éšŠåˆä½œ', icon: <Users className="text-orange-500" />, desc: 'å…¨éšŠä¸€èµ·åšä¸€å€‹å‹•ä½œï¼Œå¦‚æœé€šéåŠ  10 åˆ†ï¼', effect: 'none' }, // Effect none means just show text
  { id: 'repick', label: 'å†é¸ä¸€æ¬¡', icon: <RefreshCw className="text-green-500" />, desc: 'æ”¾æ£„é€™æ¬¡æ©Ÿæœƒå¡ï¼Œå»é¸ä¸€å€‹æ ¼å­å§ï¼', effect: 'repick' },
  { id: 'steal', label: 'åˆ†æ•¸äº’æ›', icon: <RotateCcw className="text-blue-400" />, desc: 'é–‹ç©ç¬‘çš„... å…¶å¯¦æ˜¯å¾åˆ¥äººé‚£è£¡æ‹¿ 5 åˆ†ï¼', effect: 'steal_5' },
  { id: 'double', label: 'æ´»åŠ›åŠ å€', icon: <Zap className="text-yellow-500" />, desc: 'ä¸‹ä¸€å€‹å‹•ä½œåšå¾—ç‰¹åˆ¥å¤§è²ï¼Œåˆ†æ•¸åŠ å€ï¼', effect: 'buff_double' },
];

// é«”é©èƒ½é‹å‹•é¡Œç›®åº« (æ“´å……è‡³ 24 é¡Œ)
const EXERCISE_POOL = [
  { label: 'è½‰è½‰é ­', points: 10, animal: 'ğŸ»', sport: 'ğŸ§£', task: 'æ…¢æ…¢åœ°å°‡é ­è½‰å‘å³é‚Šï¼Œå†è½‰å‘å·¦é‚Šï¼Œä¾†å› 5 æ¬¡ã€‚', hint: 'å‹•ä½œè¦æ…¢ï¼Œä¸è¦å¤ªå¤§åŠ›ï¼Œæ„Ÿè¦ºè„–å­æœ‰äº›å¾®æ‹‰ä¼¸å³å¯ã€‚', answer: 'é ¸éƒ¨æ”¾é¬†', explanation: 'æ”¾é¬†é ¸éƒ¨è‚Œè‚‰ï¼Œæ¸›å°‘è½æ•æ©Ÿæœƒã€‚' },
  { label: 'æŠ¬æŠ¬è†', points: 15, animal: 'ğŸ‡', sport: 'ğŸ‘Ÿ', task: 'ååœ¨æ¤…å­ä¸Šï¼Œè¼ªæµå°‡è†è“‹æŠ¬é«˜ï¼Œåƒåœ¨è¸æ­¥ä¸€æ¨£ 20 ä¸‹ï¼', hint: 'æ‰‹æ‰¶æ¤…èƒŒï¼ŒèƒŒæŒºç›´ï¼Œå¤§è…¿ç”¨åŠ›ã€‚', answer: 'è†è“‹æŠ¬é«˜', explanation: 'è¨“ç·´å¤§è…¿è‚ŒåŠ›ï¼Œèµ°è·¯æ›´ç©©ã€‚' },
  { label: 'èˆ‰é«˜æ‰‹', points: 10, animal: 'ğŸ¨', sport: 'ğŸ™Œ', task: 'é›™æ‰‹åæŒ‡äº¤æ‰£ï¼ŒæŒå¿ƒå‘ä¸Šï¼Œç”¨åŠ›å‘ä¸Šä¼¸å±• 10 ç§’é˜ã€‚', hint: 'æƒ³åƒæ‘¸å¤©èŠ±æ¿ï¼Œæ‰‹è‡‚ä¼¸ç›´ã€‚', answer: 'æ‰‹è‡‚ä¼¸ç›´', explanation: 'æ”¹å–„äº”åè‚©ï¼Œå‘¼å¸æ›´é †æš¢ã€‚' },
  { label: 'è½‰æ‰‹è…•', points: 10, animal: 'ğŸ±', sport: 'ğŸ‘‹', task: 'é›™æ‰‹æ¡æ‹³ï¼Œé †æ™‚é‡è½‰å‹• 10 åœˆï¼Œå†é€†æ™‚é‡è½‰ 10 åœˆã€‚', hint: 'å‹•ä½œå¤§ä¸€é»ï¼Œå……åˆ†æ´»å‹•é—œç¯€ã€‚', answer: 'é—œç¯€æ´»å‹•', explanation: 'é é˜²æ‰‹éº»ï¼Œä¿ƒé€²æœ«æ¢¢å¾ªç’°ã€‚' },
  { label: 'æ“´èƒ¸æ“', points: 15, animal: 'ğŸ¦', sport: 'ğŸ’ª', task: 'é›™æ‰‹å‘å…©å´æ‰“é–‹ï¼Œåšæ“´èƒ¸é‹å‹•ï¼Œé‡è¤‡ 10 æ¬¡ã€‚', hint: 'å¸æ°£æ‰“é–‹ï¼Œåæ°£åˆèµ·ä¾†ã€‚', answer: 'èƒ¸éƒ¨ä¼¸å±•', explanation: 'æ”¹å–„é§èƒŒï¼Œå¢åŠ è‚ºæ´»é‡ã€‚' },
  { label: 'å¢Šè…³å°–', points: 15, animal: 'ğŸ§', sport: 'ğŸ©°', task: 'æ‰¶è‘—æ¤…èƒŒï¼Œæ…¢æ…¢å¢Šèµ·è…³å°–ï¼Œåœç•™ 3 ç§’å†æ”¾ä¸‹ï¼Œåš 10 æ¬¡ã€‚', hint: 'ä¸€å®šè¦æ‰¶ç©©ï¼Œæ³¨æ„å®‰å…¨ã€‚', answer: 'å°è…¿ç”¨åŠ›', explanation: 'å°è…¿æ˜¯ç¬¬äºŒå¿ƒè‡Ÿï¼Œå¹«åŠ©è¡€æ¶²å›æµã€‚' },
  { label: 'æŠ“æŠ“æ‰‹', points: 10, animal: 'ğŸ™', sport: 'ğŸ–ï¸', task: 'ç”¨åŠ›å¼µé–‹æ‰‹æŒåƒå¸ƒï¼Œå†ç”¨åŠ›æ¡æ‹³åƒçŸ³é ­ï¼Œé‡è¤‡ 10 æ¬¡ã€‚', hint: 'æ‰‹æŒ‡å¼µåˆ°æœ€å¤§ï¼Œæ¡åˆ°æœ€ç·Šã€‚', answer: 'æ‰‹æŒ‡éˆæ´»', explanation: 'åˆºæ¿€æ‰‹éƒ¨ç©´é“ï¼Œæ´»åŒ–å¤§è…¦ã€‚' },
  { label: 'æ‰­æ‰­è…°', points: 15, animal: 'ğŸ·', sport: 'ğŸ¤¸', task: 'é›™æ‰‹æ’è…°ï¼Œä¸ŠåŠèº«å‘å·¦è½‰ï¼Œå†å‘å³è½‰ï¼Œåš 5 æ¬¡ã€‚', hint: 'å±è‚¡ä¸å‹•ï¼Œåªè½‰ä¸ŠåŠèº«ã€‚', answer: 'è…°éƒ¨æ´»å‹•', explanation: 'æ”¾é¬†è…°èƒŒï¼Œå¢åŠ è„Šæ¤éˆæ´»åº¦ã€‚' },
  { label: 'æ‹æ‹è‚©', points: 10, animal: 'ğŸµ', sport: 'ğŸ’†', task: 'å³æ‰‹æ‹å·¦è‚©ï¼Œå·¦æ‰‹æ‹å³è‚©ï¼Œå„ 10 ä¸‹ã€‚', hint: 'è¼•è¼•æ‹æ‰“ï¼ŒåƒæŒ‰æ‘©ä¸€æ¨£ã€‚', answer: 'è‚©é ¸æ”¾é¬†', explanation: 'ä¿ƒé€²è¡€æ¶²å¾ªç’°ï¼Œç·©è§£ç— ç—›ã€‚' },
  { label: 'æ·±å‘¼å¸', points: 10, animal: 'ğŸ³', sport: 'ğŸŒ¬ï¸', task: 'é–‰çœ¼ï¼Œé¼»å­æ·±å¸æ°£ï¼Œå˜´å·´æ…¢åæ°£ï¼Œåš 3 æ¬¡ã€‚', hint: 'å¸æ°£è‚šå­é¼“ï¼Œåæ°£è‚šå­ç¸®ã€‚', answer: 'èº«å¿ƒæ”¾é¬†', explanation: 'èª¿ç¯€è‡ªå¾‹ç¥ç¶“ï¼Œé™ä½ç„¦æ…®ã€‚' },
  { label: 'ç¿¹è…³å°–', points: 15, animal: 'ğŸ¢', sport: 'ğŸ¦¶', task: 'åè‘—è…³è·Ÿè‘—åœ°ï¼Œè…³å°–ç”¨åŠ›å¾€ä¸Šç¿¹ï¼Œåš 15 æ¬¡ã€‚', hint: 'å°è…¿å‰å´æœƒç— ç— çš„å–”ã€‚', answer: 'è…³èƒŒå‹¾èµ·', explanation: 'é é˜²è·Œå€’ï¼Œè¨“ç·´æŠ¬è…³è‚Œè‚‰ã€‚' },
  { label: 'å¤§ç¬‘æ“', points: 20, animal: 'ğŸ˜¸', sport: 'ğŸ˜†', task: 'é›™æ‰‹æ’è…°ï¼Œå¤§ç¬‘ä¸‰è²ã€Œå“ˆï¼å“ˆï¼å“ˆï¼ã€', hint: 'è¶Šå¤§è²è¶Šå¥½ï¼Œå‡ç¬‘ä¹Ÿèƒ½è®ŠçœŸç¬‘ã€‚', answer: 'è…¹éƒ¨ç”¨åŠ›', explanation: 'æå‡å…ç–«åŠ›ï¼Œé‡‹æ”¾å£“åŠ›ã€‚' },
  { label: 'åˆ’èˆ¹è¶£', points: 15, animal: 'ğŸš£', sport: 'ğŸš£', task: 'é›™æ‰‹æ¡æ‹³å‘å‰ä¼¸ï¼Œåšåˆ’èˆ¹å‹•ä½œï¼Œä¾†å› 10 æ¬¡ã€‚', hint: 'èº«é«”è·Ÿè‘—å¾®å¾®å‰å¾Œæ“ºå‹•ã€‚', answer: 'èƒŒéƒ¨æ´»å‹•', explanation: 'è¨“ç·´èƒŒè‚Œï¼Œæ”¹å–„åœ“è‚©ã€‚' },
  { label: 'å–æ°´è¶£', points: 10, animal: 'ğŸ¥›', sport: 'ğŸ’§', task: 'æš«åœä¸€ä¸‹ï¼Œæ‹¿èµ·æ°´æ¯å–å…©å£æ°´ã€‚', hint: 'æ…¢æ…¢å–ï¼Œä¸è¦æ€¥ã€‚', answer: 'è£œå……æ°´åˆ†', explanation: 'é é˜²è„«æ°´ï¼Œä¿ƒé€²ä»£è¬ã€‚' },
  { label: 'ç›¸æ’²è¹²', points: 20, animal: 'ğŸ»', sport: 'ğŸ¥‹', task: 'è…³é–‹æ¯”è‚©å¯¬ï¼Œæ‰‹æ‰¶è†å¾®è¹² 5 ç§’ã€‚', hint: 'èƒŒæŒºç›´ï¼Œå±è‚¡å¾€å¾Œåã€‚', answer: 'ä¸‹è‚¢è‚ŒåŠ›', explanation: 'å¼·åŒ–è…¿éƒ¨èˆ‡è‡€éƒ¨è‚Œè‚‰ã€‚' },
  { label: 'æ¯”æ„›å¿ƒ', points: 15, animal: 'ğŸ¦„', sport: 'â¤ï¸', task: 'å…¨éšŠæ¯”å‡ºæ„›å¿ƒï¼Œèªªã€Œæˆ‘æ„›ä½ ã€ï¼', hint: 'è¡¨é”æ„Ÿè¬èˆ‡æ„›æ„ã€‚', answer: 'æ­£å‘äº’å‹•', explanation: 'ä¿ƒé€²å‚¬ç”¢ç´ åˆ†æ³Œï¼Œæ„Ÿåˆ°å¹¸ç¦ã€‚' },
  { label: 'æ‹æ‹è…¿', points: 10, animal: 'ğŸ¼', sport: 'ğŸ™Œ', task: 'ç”¨é›™æ‰‹è¼•æ‹å¤§è…¿å¤–å´èˆ‡å…§å´ï¼Œå„ 10 ä¸‹ã€‚', hint: 'ç”±ä¸Šå¾€ä¸‹æ‹ï¼Œæ”¾é¬†è‚Œè‚‰ã€‚', answer: 'è…¿éƒ¨æ”¾é¬†', explanation: 'ä¿ƒé€²ä¸‹è‚¢å¾ªç’°ã€‚' },
  { label: 'å‰ªåˆ€æ‰‹', points: 15, animal: 'ğŸ¦€', sport: 'âœŒï¸', task: 'é›™æ‰‹æ¯”å‰ªåˆ€ã€çŸ³é ­ã€å¸ƒï¼Œå¿«é€Ÿè®Šæ› 10 æ¬¡ã€‚', hint: 'è€ƒé©—åæ‡‰é€Ÿåº¦ã€‚', answer: 'è…¦åŠ›æ¿€ç›ª', explanation: 'é é˜²å¤±æ™ºï¼Œè¨“ç·´åæ‡‰ã€‚' },
  { label: 'è³è³è‚©', points: 10, animal: 'ğŸ¦’', sport: 'ğŸ¤·', task: 'è‚©è†€ç”¨åŠ›å¾€ä¸Šè³ï¼Œå†çªç„¶æ”¾é¬†ï¼Œåš 10 æ¬¡ã€‚', hint: 'è³è‚©æ™‚å¸æ°£ï¼Œæ”¾é¬†æ™‚åæ°£ã€‚', answer: 'è‚©é ¸é‡‹å£“', explanation: 'æ¶ˆé™¤è‚©è†€ç·Šå¼µå£“åŠ›ã€‚' },
  { label: 'è½‰è…³è¸', points: 10, animal: 'ğŸ•', sport: 'â­•', task: 'åè‘—ï¼Œè½‰å‹•å³è…³è¸ 10 åœˆï¼Œå†æ›å·¦è…³ã€‚', hint: 'å‹•ä½œæ”¾æ…¢ï¼Œç•«å¤§åœ“ã€‚', answer: 'é—œç¯€æ´»å‹•', explanation: 'å¢åŠ è…³è¸ç©©å®šæ€§ã€‚' },
  { label: 'ç©ºä¸­è¸©', points: 20, animal: 'ğŸš²', sport: 'ğŸš²', task: 'åç©©ï¼Œé›™è…³åœ¨ç©ºä¸­è¸©è…³è¸è»Š 10 ç§’ã€‚', hint: 'æ‰‹æ‰¶æ¤…å­ï¼Œæ ¸å¿ƒç”¨åŠ›ã€‚', answer: 'è…¹éƒ¨æ ¸å¿ƒ', explanation: 'è¨“ç·´è…¹è‚Œèˆ‡è…¿éƒ¨ã€‚' },
  { label: 'æ‰‹è‚˜ç¢°', points: 15, animal: 'ğŸ¦', sport: 'ğŸ’ª', task: 'é›™æ‰‹æŠ±é ­ï¼Œå³æ‰‹è‚˜ç¢°å·¦è†è“‹ï¼Œåš 5 æ¬¡ã€‚', hint: 'é‡åŠ›è€Œç‚ºï¼Œç¢°ä¸åˆ°æ²’é—œä¿‚ã€‚', answer: 'èº«é«”å”èª¿', explanation: 'è¨“ç·´æ–œè…¹è‚Œèˆ‡å”èª¿æ€§ã€‚' },
  { label: 'æ‘¸æ‘¸èƒŒ', points: 15, animal: 'ğŸˆ', sport: 'ğŸ‘‹', task: 'å³æ‰‹èˆ‰é«˜å¾€å¾Œæ‘¸èƒŒï¼Œå·¦æ‰‹å¹«å¿™å£“ä¸€ä¸‹æ‰‹è‚˜ã€‚', hint: 'åœç•™ 10 ç§’ï¼Œæ›é‚Šã€‚', answer: 'æ‰‹è‡‚ä¼¸å±•', explanation: 'ä¼¸å±•æ‰‹è‡‚ä¸‰é ­è‚Œã€‚' },
  { label: 'æ“ŠæŒæ¨‚', points: 20, animal: 'ğŸ¬', sport: 'ğŸ‘', task: 'è·Ÿå·¦å³é„°å±…æ“ŠæŒï¼Œå¤§å–Šã€ŒåŠ æ²¹ã€ï¼', hint: 'çœ‹è‘—å°æ–¹çš„çœ¼ç›ã€‚', answer: 'ç¤¾äº¤äº’å‹•', explanation: 'å¢é€²äººéš›é—œä¿‚ã€‚' },
];

const DEFAULT_TEAMS = [
  { id: 't1', name: 'ç´…è˜‹æœéšŠ', color: 'bg-red-100', border: 'border-red-500', text: 'text-red-700', score: 0, avatar: 'ğŸ' },
  { id: 't2', name: 'è—ç²¾éˆéšŠ', color: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-700', score: 0, avatar: 'ğŸ«' },
];

// --- å»ºç«‹ç’°ç‹€åœ°åœ– ---
// 7x7 Grid: 
// Row 0: 0,1,2,3,4,5,6 (7å€‹)
// Row 1: 23, [Center], 7
// Row 2: 22, [Center], 8
// ...
// Row 6: 18,17,16,15,14,13,12 (7å€‹å€’åº)
const generateBoard = () => {
  const tasks = [...EXERCISE_POOL].sort(() => Math.random() - 0.5); // æ´—ç‰Œ
  // å»ºç«‹ 24 å€‹æ ¼å­
  return tasks.slice(0, 24).map((task, i) => ({
    ...task,
    id: i,
    owner: null, // è¢«å“ªéšŠä½”é ˜
  }));
};

export default function HealthMonopolyV2() {
  const [gameState, setGameState] = useState('setup'); // setup, playing, finished
  const [teams, setTeams] = useState(DEFAULT_TEAMS);
  const [board, setBoard] = useState([]);
  const [turn, setTurn] = useState(0); // éšŠä¼ index
  const [modalData, setModalData] = useState(null); // æ§åˆ¶å½ˆçª— (é¡Œç›®æˆ–æ©Ÿæœƒå¡)
  const [winner, setWinner] = useState(null);
  
  // éšŠä¼ Buff ç‹€æ…‹ (ä¾‹å¦‚: ä¸‹ä¸€é¡Œåˆ†æ•¸åŠ å€)
  const [teamBuffs, setTeamBuffs] = useState({}); // { teamId: { doubleScore: boolean } }

  const activeTeam = teams[turn];

  // --- éŠæˆ²é‚è¼¯ ---

  const addTeam = () => {
    if (teams.length >= 4) return;
    const variants = [
      { color: 'bg-green-100', border: 'border-green-500', text: 'text-green-700', avatar: 'ğŸ¥' },
      { color: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-700', avatar: 'ğŸŒ' }
    ];
    const idx = teams.length;
    setTeams([...teams, { id: `t${Date.now()}`, name: `æ–°éšŠä¼ ${idx+1}`, score: 0, ...variants[idx-2]||variants[0] }]);
  };

  const removeTeam = (id) => {
    if (teams.length <= 1) return;
    setTeams(teams.filter(t => t.id !== id));
  };

  const updateTeamName = (id, newName) => {
    setTeams(teams.map(t => t.id === id ? { ...t, name: newName } : t));
  };

  const startGame = () => {
    setBoard(generateBoard());
    setGameState('playing');
    setTurn(0);
    setTeamBuffs({});
  };

  // é»é¸é¡Œç›®æ ¼
  const handleTileClick = (tile) => {
    if (tile.owner) return; // å·²è¢«ä½”é ˜
    setModalData({ type: 'task', data: tile });
  };

  // é»é¸æ©Ÿæœƒå¡
  const handleChanceClick = () => {
    const card = CHANCE_DECK[Math.floor(Math.random() * CHANCE_DECK.length)];
    setModalData({ type: 'chance', data: card });
  };

  // å®Œæˆé¡Œç›®
  const completeTask = (points) => {
    if (!modalData) return;
    
    // è™•ç†åˆ†æ•¸ (æª¢æŸ¥æ˜¯å¦æœ‰åŠ å€ Buff)
    let finalPoints = points;
    if (teamBuffs[activeTeam.id]?.doubleScore) {
      finalPoints *= 2;
      // æ¶ˆè€— Buff
      setTeamBuffs(prev => ({ ...prev, [activeTeam.id]: { ...prev[activeTeam.id], doubleScore: false } }));
    }

    const newTeams = [...teams];
    newTeams[turn].score += finalPoints;
    setTeams(newTeams);

    // ä½”é ˜æ ¼å­
    if (modalData.type === 'task') {
      const newBoard = board.map(t => t.id === modalData.data.id ? { ...t, owner: activeTeam } : t);
      setBoard(newBoard);
    }

    finishTurn(newTeams);
  };

  // åŸ·è¡Œæ©Ÿæœƒå¡æ•ˆæœ
  const applyChanceEffect = () => {
    const card = modalData.data;
    const effect = card.effect;
    let newTeams = [...teams];
    let nextTurnIndex = (turn + 1) % teams.length; // é è¨­ä¸‹ä¸€ä½

    if (effect === 'repick') {
      setModalData(null); // é—œé–‰è¦–çª—ï¼Œä¸æ›äºº
      return; 
    }

    if (effect === 'add_15') {
      newTeams[turn].score += 15;
    }

    if (effect === 'steal_10' || effect === 'steal_5') {
      const amount = effect === 'steal_10' ? 10 : 5;
      // æ‰¾æœ€é«˜åˆ†éšŠä¼ (æ’é™¤è‡ªå·±)
      const others = newTeams.filter(t => t.id !== activeTeam.id);
      if (others.length > 0) {
        const victim = others.reduce((prev, curr) => (prev.score > curr.score) ? prev : curr);
        const victimIndex = newTeams.findIndex(t => t.id === victim.id);
        
        // åŸ·è¡Œå·åˆ†
        newTeams[victimIndex].score = Math.max(0, newTeams[victimIndex].score - amount);
        newTeams[turn].score += amount;
      }
    }

    if (effect === 'buff_double') {
      setTeamBuffs(prev => ({ ...prev, [activeTeam.id]: { ...prev[activeTeam.id], doubleScore: true } }));
    }

    if (effect === 'extra_turn') {
      nextTurnIndex = turn; // ç¶­æŒåŒä¸€ä½
    }

    setTeams(newTeams);
    finishTurn(newTeams, nextTurnIndex);
  };

  // çµæŸå›åˆä¸¦æª¢æŸ¥å‹åˆ©
  const finishTurn = (currentTeams, nextIndex = null) => {
    setModalData(null);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰äººé”åˆ° 100 åˆ†
    const winnerTeam = currentTeams.find(t => t.score >= WINNING_SCORE);
    if (winnerTeam) {
      setWinner(winnerTeam);
      setGameState('finished');
    } else {
      setTurn(nextIndex !== null ? nextIndex : (turn + 1) % teams.length);
    }
  };

  const resetGame = () => {
    setTeams(DEFAULT_TEAMS.map(t => ({...t, score: 0})));
    setGameState('setup');
    setWinner(null);
  };

  // --- Render ---

  if (gameState === 'setup') {
    return (
      <div className="min-h-screen bg-green-50 font-sans flex flex-col items-center justify-center p-4">
        <div className="bg-white p-8 rounded-[3rem] shadow-2xl w-full max-w-2xl border-8 border-green-200">
          <h1 className="text-4xl md:text-5xl font-bold text-center text-green-600 mb-2 flex items-center justify-center gap-3">
             <Activity size={56} /> å¥åº·å‹•ä¸€å‹•
          </h1>
          <p className="text-xl text-center text-gray-400 mb-8">æ¶ 100 åˆ†å¤§ä½œæˆ°</p>
          
          <h2 className="text-2xl text-center text-gray-600 mb-6 font-bold flex items-center justify-center gap-2">
            <Edit3 size={24} /> é»é¸éšŠåä¿®æ”¹
          </h2>
          
          <div className="space-y-4 mb-8">
            {teams.map((team) => (
              <div key={team.id} className="flex items-center gap-4 p-4 bg-gray-50 rounded-2xl border-2 border-gray-100 shadow-sm transition hover:border-green-300">
                <span className="text-4xl">{team.avatar}</span>
                <input 
                  type="text" 
                  value={team.name}
                  onChange={(e) => updateTeamName(team.id, e.target.value)}
                  className="flex-1 text-2xl p-2 border-b-2 border-gray-300 focus:border-green-400 outline-none bg-transparent font-bold text-gray-700"
                />
                {teams.length > 1 && (
                  <button onClick={() => removeTeam(team.id)} className="text-gray-400 hover:text-red-500 font-bold px-3 py-1 rounded-lg hover:bg-red-50 transition">
                    ç§»é™¤
                  </button>
                )}
              </div>
            ))}
          </div>

          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <button onClick={addTeam} disabled={teams.length >= 4} className="px-6 py-4 rounded-full bg-blue-100 text-blue-600 font-bold text-xl hover:bg-blue-200 transition flex items-center justify-center gap-2">
              <Users /> æ–°å¢éšŠä¼
            </button>
            <button onClick={startGame} className="px-10 py-4 rounded-full bg-green-500 text-white font-bold text-2xl hover:bg-green-600 shadow-xl hover:scale-105 transition flex items-center justify-center gap-2">
              é–‹å§‹æŒ‘æˆ° <ArrowRight />
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (gameState === 'finished') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-100 to-green-100 flex flex-col items-center justify-center p-4">
         <Trophy size={140} className="text-yellow-500 mx-auto drop-shadow-2xl mb-8 animate-bounce" />
         <h1 className="text-6xl font-black text-green-700 mb-2 drop-shadow-sm">æ­å–œç²å‹ï¼</h1>
         <div className="bg-white p-12 rounded-[3rem] shadow-2xl text-center border-8 border-yellow-400 max-w-2xl w-full">
            <h2 className="text-5xl font-bold text-gray-800 mb-6 flex items-center justify-center gap-4">
                <span className="text-7xl">{winner?.avatar}</span> 
                {winner?.name}
            </h2>
            <div className="text-4xl text-gray-600 mb-10 font-bold">
                ç¸½å¾—åˆ†ï¼š<span className="text-red-500 text-6xl">{winner?.score}</span> åˆ†
            </div>
            <button onClick={resetGame} className="w-full px-8 py-5 rounded-full bg-green-500 text-white font-bold text-3xl hover:bg-green-600 shadow-xl flex items-center justify-center gap-3 transition">
              <RotateCcw /> å†ç©ä¸€æ¬¡
            </button>
         </div>
      </div>
    );
  }

  // --- ç¹ªè£½ç‰ˆé¢ ---
  // å°‡ 24 å€‹æ ¼å­æ’åˆ—æˆ 7x7 çš„å¤–æ¡†
  const renderTile = (index) => {
    // æ ¹æ“š 7x7 çš„ç´¢å¼•é‚è¼¯æ˜ å°„åˆ° board é™£åˆ—
    // å¤–æ¡†ç´¢å¼•é †åºï¼šä¸Šæ’(0-6), å³æ’(7-11), ä¸‹æ’(12-18å€’åº), å·¦æ’(19-23å€’åº)
    // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¨ CSS Grid å®šä½
    return null; 
  };

  // å°‡ä¸€ç¶­é™£åˆ—(24å€‹)åˆ†é…åˆ°å°æ‡‰çš„ CSS Grid Area
  // æˆ‘å€‘ä½¿ç”¨ç°¡å–®çš„ Grid æ’åˆ—ï¼Œå°‡ä¸­é–“ç•™ç©º
  // Grid 7x7 = 49 cells.
  // Cells 0-6 (Top), 7,13,14,20,21,27,28,34,35,41 (Sides...), 42-48 (Bottom)
  // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç›´æ¥ç”Ÿæˆ 49 å€‹ divï¼Œå¦‚æœæ˜¯é‚Šç•Œå‰‡æ¸²æŸ“ Tileï¼Œä¸­é–“å‰‡æ¸²æŸ“æ©Ÿæœƒå¡å€
  const gridCells = [];
  
  // å»ºç«‹åœ°åœ–ç´¢å¼•æ˜ å°„
  // é †æ™‚é‡ï¼š
  // Top: 0,1,2,3,4,5,6
  // Right: 7,8,9,10,11
  // Bottom: 12,13,14,15,16,17,18 (Reversed visually in grid but index flows)
  // Left: 19,20,21,22,23
  
  // ç‚ºäº†é…åˆ Grid è¦–è¦º (row, col)
  const getBoardIndex = (row, col) => {
    if (row === 0) return col; // 0-6
    if (row === 6) return 18 - (col); // 12-18 (col 0 is 18, col 6 is 12) -> wait. 
    // Let's do a simple path mapping
    // Top Row (0): 0,1,2,3,4,5,6
    // Right Col (6): 7,8,9,10,11 (rows 1-5)
    // Bottom Row (6): 12,13,14,15,16,17,18 (cols 6-0)
    // Left Col (0): 19,20,21,22,23 (rows 5-1)
    
    if (row === 0) return col;
    if (col === 6 && row > 0 && row < 6) return 6 + row;
    if (row === 6) return 12 + (6 - col);
    if (col === 0 && row > 0 && row < 6) return 18 + (6 - row);
    
    return -1; // Center area
  };

  for (let r = 0; r < 7; r++) {
    for (let c = 0; c < 7; c++) {
      const boardIdx = getBoardIndex(r, c);
      
      // ä¸­å¤®å€åŸŸ (åˆä½µ)
      if (r >= 2 && r <= 4 && c >= 2 && c <= 4) {
        if (r === 2 && c === 2) {
           gridCells.push(
             <div key="center" className="col-span-3 row-span-3 bg-white/50 rounded-3xl border-4 border-dashed border-purple-300 flex flex-col items-center justify-center p-4 m-2 shadow-inner hover:bg-purple-50 transition cursor-pointer group" onClick={handleChanceClick}>
                <Gift className="text-purple-500 w-16 h-16 mb-2 group-hover:scale-110 transition-transform" />
                <div className="text-2xl font-bold text-purple-700">æ©ŸæœƒåŠŸèƒ½å¡</div>
                <div className="text-sm text-purple-500 font-bold bg-white px-3 py-1 rounded-full mt-2">é»æˆ‘æŠ½å¡ (å…±10å¼µ)</div>
             </div>
           );
        }
        continue;
      }
      
      // ç©ºç™½å€åŸŸ (éä¸­å¤®ä¹Ÿéé‚Šæ¡†)
      if (boardIdx === -1) {
        gridCells.push(<div key={`empty-${r}-${c}`} className=""></div>);
        continue;
      }

      // é‚Šæ¡†é¡Œç›®æ ¼
      const tile = board[boardIdx];
      if (!tile) continue; // Should not happen

      gridCells.push(
        <button 
            key={tile.id}
            onClick={() => handleTileClick(tile)}
            disabled={!!tile.owner || gameState !== 'playing'}
            className={`
                relative w-full h-full aspect-square rounded-xl flex items-center justify-center p-1 transition-all duration-300 group overflow-hidden shadow-md border-b-4 border-black/10
                ${tile.owner 
                    ? `${tile.owner.color} ${tile.owner.border} border-4` 
                    : `bg-white hover:bg-orange-50 hover:scale-105`
                }
            `}
        >
             {/* å·¦ä¸Šè§’ï¼šä»»å‹™åœ–ç¤º (å›ºå®šä¸å‹•) */}
             <div className="absolute top-1 left-1 md:top-2 md:left-2 opacity-100 z-10 pointer-events-none">
                 <SportDoll animal={tile.animal} sport={tile.sport} size="text-2xl md:text-3xl" />
             </div>

             {/* ä¸­é–“ï¼šé¡Œç›®æ–‡å­— */}
             <div className={`font-bold text-xs md:text-sm leading-tight text-center px-1 mt-6 md:mt-8 w-full z-0 break-words text-gray-700 ${tile.owner ? 'opacity-50' : ''}`}>
                 {tile.label}
                 <br/><span className="text-[10px] text-gray-400">{tile.points}åˆ†</span>
             </div>

             {/* å³ä¸‹è§’ï¼šéšŠä¼æ¨™è¨˜ (ä½”é ˜å¾Œé¡¯ç¤º) */}
             {tile.owner && (
                 <div className="absolute bottom-1 right-1 bg-white rounded-full p-1 shadow-md border border-gray-200 z-20 animate-bounce">
                     <span className="text-lg md:text-xl leading-none">{tile.owner.avatar}</span>
                     <div className="absolute -top-1 -right-1 bg-green-500 rounded-full p-0.5">
                         <CheckCircle className="w-3 h-3 text-white" />
                     </div>
                 </div>
             )}
        </button>
      );
    }
  }

  return (
    <div className="min-h-screen bg-amber-50 font-sans flex flex-col relative overflow-hidden">
      
      {/* æ¨™é¡Œæ¬„ */}
      <header className="bg-white/90 backdrop-blur-md px-6 py-4 shadow-sm border-b-2 border-orange-200 flex flex-col md:flex-row justify-between items-center sticky top-0 z-20 gap-4">
        <h1 className="text-3xl font-black text-orange-600 flex items-center gap-3 tracking-wide">
            <Activity className="text-orange-500" /> å¥åº·å‹•ä¸€å‹•
        </h1>
        
        {/* åˆ†æ•¸æ¿ */}
        <div className="flex gap-4 overflow-x-auto pb-1 md:pb-0 w-full md:w-auto px-2">
            {teams.map(t => (
                <div key={t.id} className={`flex items-center gap-2 px-4 py-2 rounded-full border-2 transition-all ${t.id === activeTeam.id ? `${t.border} bg-white shadow-md scale-105` : 'border-transparent bg-gray-100 opacity-60'}`}>
                    <span className="text-2xl">{t.avatar}</span>
                    <div className="flex flex-col leading-none">
                        <span className={`font-bold text-sm ${t.text}`}>{t.name}</span>
                        <span className="font-black text-xl">{t.score} <span className="text-xs text-gray-400">/ 100</span></span>
                    </div>
                    {teamBuffs[t.id]?.doubleScore && <span className="bg-yellow-300 text-xs px-1 rounded animate-pulse">x2</span>}
                </div>
            ))}
        </div>
      </header>

      <main className="flex-1 flex flex-col lg:flex-row p-4 gap-6 max-w-7xl mx-auto w-full h-[calc(100vh-80px)]">
        
        {/* å·¦å´ï¼š7x7 éŠæˆ²ç‰ˆé¢ */}
        <div className="flex-1 bg-white rounded-[2rem] shadow-xl p-2 md:p-4 border-4 border-orange-200 overflow-hidden flex flex-col">
            <div className="grid grid-cols-7 grid-rows-7 gap-1 md:gap-2 w-full h-full aspect-square max-h-[80vh] mx-auto">
                {gridCells}
            </div>
        </div>

        {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
        <div className="w-full lg:w-80 flex flex-col gap-4">
            {/* è¼ªæ¬¡å¡ */}
            <div className="bg-white rounded-[2rem] shadow-lg p-6 border-b-8 border-orange-100 text-center">
                <div className="text-gray-400 font-bold mb-2 uppercase text-xs tracking-widest">CURRENT TURN</div>
                <div className={`w-full py-4 rounded-2xl shadow-sm border-2 ${activeTeam.color} ${activeTeam.border} flex flex-col items-center gap-1 mb-2`}>
                    <span className="text-5xl animate-bounce">{activeTeam.avatar}</span>
                    <span className={`text-2xl font-black ${activeTeam.text}`}>{activeTeam.name}</span>
                </div>
                {teamBuffs[activeTeam.id]?.doubleScore && (
                     <div className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center gap-1 mb-2">
                        <Zap size={14} /> åˆ†æ•¸åŠ å€ä¸­ï¼
                     </div>
                )}
                <div className="text-gray-500 text-sm">è«‹é»é¸å¤–æ¡†é¡Œç›®ï¼Œæˆ–é»é¸ä¸­é–“æ©Ÿæœƒå¡ã€‚</div>
            </div>

            {/* èªªæ˜å¡ */}
            <div className="bg-blue-50 rounded-3xl p-6 border-2 border-blue-100 flex-1 flex flex-col items-center justify-center text-center">
                 <Info className="text-blue-400 w-10 h-10 mb-2" />
                 <h4 className="text-blue-700 font-bold text-lg mb-2">éŠæˆ²è¦å‰‡</h4>
                 <ul className="text-blue-800/70 text-sm text-left list-disc list-inside space-y-1">
                     <li>ç›®æ¨™ï¼šå…ˆç²å¾— <strong>100åˆ†</strong> è€…ç²å‹ã€‚</li>
                     <li>æ¯é¡Œ 10-20 åˆ†ä¸ç­‰ã€‚</li>
                     <li>æ©Ÿæœƒå¡å¯èƒ½åŠ åˆ†ï¼Œä¹Ÿå¯èƒ½...å˜¿å˜¿ã€‚</li>
                 </ul>
            </div>
        </div>
      </main>

      {/* å½ˆçª—ï¼šé¡Œç›®æˆ–æ©Ÿæœƒå¡ */}
      {modalData && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className={`bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden border-8 flex flex-col max-h-[90vh] ${modalData.type === 'chance' ? 'border-purple-200' : 'border-white'}`}>
                
                {/* Header */}
                <div className={`p-6 text-center relative shrink-0 ${modalData.type === 'chance' ? 'bg-purple-100' : 'bg-orange-100'}`}>
                    <div className="flex justify-center mb-2">
                        <div className="bg-white/60 p-4 rounded-full shadow-sm">
                            {modalData.type === 'chance' 
                                ? <div className="text-5xl">{modalData.data.icon}</div>
                                : <SportDoll animal={modalData.data.animal} sport={modalData.data.sport} size="text-5xl" />
                            }
                        </div>
                    </div>
                    <h2 className="text-3xl font-black text-gray-800 mb-1">{modalData.data.label}</h2>
                    {modalData.type === 'task' && (
                        <span className="inline-block bg-white/50 px-3 py-0.5 rounded-full text-sm font-bold text-gray-700">
                            ç©åˆ†ï¼š{modalData.data.points} {teamBuffs[activeTeam.id]?.doubleScore ? '(x2)' : ''}
                        </span>
                    )}
                </div>
                
                {/* Content */}
                <div className="p-6 bg-white overflow-y-auto flex-1 space-y-6 text-lg">
                    {/* é¡Œç›®/æ©Ÿæœƒå…§å®¹ */}
                    <div className="text-center">
                        <p className="text-2xl font-bold text-gray-800 leading-relaxed mb-4">
                            {modalData.type === 'task' ? modalData.data.task : modalData.data.desc}
                        </p>
                    </div>

                    {/* æç¤º (åƒ…é¡Œç›®æœ‰) */}
                    {modalData.type === 'task' && (
                        <>
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-xl">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <Lightbulb className="text-yellow-500" size={20} />
                                        <h4 className="font-bold text-yellow-700 text-sm">è€å¸«å°æç¤º</h4>
                                    </div>
                                    <button onClick={() => speak(modalData.data.hint)} className="btn-icon"><Volume2 size={20} /></button>
                                </div>
                                <p className="text-gray-700">{modalData.data.hint}</p>
                            </div>

                            <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-xl space-y-4">
                                <div>
                                    <div className="flex items-center justify-between mb-1">
                                        <div className="flex items-center gap-2">
                                            <CheckCircle className="text-blue-500" size={20} />
                                            <h4 className="font-bold text-blue-700 text-sm">å‹•ä½œæ¨™æº–</h4>
                                        </div>
                                        <button onClick={() => speak(modalData.data.answer)} className="btn-icon"><Volume2 size={20} /></button>
                                    </div>
                                    <p className="text-gray-800 font-bold">{modalData.data.answer}</p>
                                </div>
                                <div className="border-t border-blue-100 pt-3">
                                    <div className="flex items-center justify-between mb-1">
                                        <div className="flex items-center gap-2">
                                            <BookOpen className="text-blue-500" size={20} />
                                            <h4 className="font-bold text-blue-700 text-sm">çŸ¥è­˜å°ç™¾ç§‘</h4>
                                        </div>
                                        <button onClick={() => speak(modalData.data.explanation)} className="btn-icon"><Volume2 size={20} /></button>
                                    </div>
                                    <p className="text-gray-600 text-sm">{modalData.data.explanation}</p>
                                </div>
                            </div>
                        </>
                    )}
                </div>

                {/* Footer Buttons */}
                <div className="p-4 bg-gray-50 border-t border-gray-100 shrink-0 flex gap-3">
                     {modalData.type === 'task' ? (
                         <>
                            <button onClick={() => setModalData(null)} className="flex-1 py-3 rounded-2xl bg-gray-200 text-gray-500 font-bold hover:bg-gray-300">å–æ¶ˆ/è·³é</button>
                            <button onClick={() => completeTask(modalData.data.points)} className="flex-[2] py-3 rounded-2xl bg-green-500 text-white font-bold hover:bg-green-600 shadow-lg flex items-center justify-center gap-2">
                                <CheckCircle /> å®ŒæˆæŒ‘æˆ°
                            </button>
                         </>
                     ) : (
                         <button onClick={applyChanceEffect} className="w-full py-3 rounded-2xl bg-purple-500 text-white font-bold hover:bg-purple-600 shadow-lg">
                             ç¢ºèª (åŸ·è¡Œæ•ˆæœ)
                         </button>
                     )}
                </div>
            </div>
        </div>
      )}

      <style jsx>{`
        .btn-icon {
            @apply bg-white/50 p-2 rounded-full hover:bg-white text-gray-600 transition;
        }
      `}</style>
    </div>
  );
}
